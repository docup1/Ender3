# Конфигурация Klipper для Ender 3 (плата Creality 4.2.7)

Этот репозиторий содержит конфигурацию **Klipper** для **Ender 3** с **платой Creality 4.2.7**. Конфигурация оптимизирована для стабильной работы, включает виброразвязку (input shaping), макросы для смены филамента, настройки старта и отмены печати.

## Основные функции  
- **Виброразвязка (Input Shaper)** для уменьшения вибраций и улучшения качества печати.  
- **Макросы для управления печатью**: смена филамента (`M600`), начало печати (`PRINT_START`), отмена печати (`CANCEL_PRINT`).  
- **Поддержка дисплея ST7920** с энкодером.  
- **PID-регулирование температуры** для экструдера и стола.  
- **Виртуальная SD-карта** для управления файлами G-code.

## Основные параметры конфигурации  

### Базовые настройки  
- **Кинематика:** Картезианская  
- **Максимальная скорость:** 300 мм/с  
- **Максимальное ускорение:** 3000 мм/с²  
- **Максимальная скорость по Z:** 5 мм/с  

### Пин-аут и аппаратные настройки  
- **Плата:** Creality 4.2.7  
- **Настройки шаговых двигателей:**  
  - X-ось: `PB9`, `PC2`, `PC3`  
  - Y-ось: `PB7`, `PB8`, `PC3`  
  - Z-ось: `PB5`, `PB6`, `PC3`  
  - Экструдер: `PB3`, `PB4`, `PC3`  
- **Датчики температуры:** EPCOS 100K B57560G104F  

## Обзор макросов  

### `M600` — Смена филамента  
Автоматически ставит печать на паузу, поднимает ось Z и нагревает сопло для смены филамента.  

### `PRINT_START` — Старт печати  
Подготавливает принтер к новой печати: устанавливает температуры, выполняет калибровку сетки стола и очищает сопло.  

### `CANCEL_PRINT` — Отмена печати  
Останавливает печать, поднимает ось Z, выключает нагреватели и возвращает головку в начальную позицию.

## Пример макросов  

### `PRINT_START`  
```gcode
[gcode_macro PRINT_START]
gcode:
    {% set BED_TEMP = params.BED|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER|default(180)|float %}
    G90 ; Абсолютные координаты
    M83 ; Режим относительного движения экструдера
    M104 S{EXTRUDER_TEMP}
    M140 S{BED_TEMP}
    M190 S{BED_TEMP}
    M109 S{EXTRUDER_TEMP}
    G28 ; Нホーム всех осей
    BED_MESH_CLEAR
    BED_MESH_CALIBRATE
    LINE_PURGE
```

### `CANCEL_PRINT`  
```gcode
[gcode_macro CANCEL_PRINT]
gcode:
    M117 Отмена печати
    TURN_OFF_HEATERS
    G91
    G1 Z10 F300
    G90
    G1 X0 Y0 F3000
    M84
    CLEAR_PAUSE
```

## Установка  

1. **Прошивка Klipper** на Ender 3 с платой Creality 4.2.7.  
2. **Копирование конфигурационного файла** в папку конфигурации Klipper (`/home/klipper/config/`).  
3. **Перезапуск Klipper** и проверка конфигурации на наличие ошибок.  

## Решение проблем  

- **Ошибка `pause_resume not found`:** добавьте секцию `[pause_resume]` в конфиг.  
- **Ошибка `CANCEL_PRINT` not found:** убедитесь, что макрос `CANCEL_PRINT` определён правильно.  

Более подробную информацию можно найти в [документации Klipper](https://www.klipper3d.org/).  
